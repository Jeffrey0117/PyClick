# PyClick 動作安全機制規格

## 問題描述

當 PyClick 自動執行動作（移動游標、點擊、按鍵）時，如果用戶正在操作滑鼠或鍵盤，可能會造成：

1. **游標被搶走** — 用戶正在拖曳檔案，突然游標飛走
2. **誤點擊** — 用戶正在輸入，PyClick 點了別的地方導致焦點跳掉
3. **操作中斷** — 用戶正在進行重要操作，被 PyClick 打斷
4. **資料損失** — 極端情況下可能導致誤刪、誤送等

---

## 解決方案討論

### 方案 A：動作前提示（Toast 預警）

```
執行前 0.5 秒顯示 Toast：
┌────────────────────────┐
│ ⚡ 即將執行點擊...      │
│ 按 ESC 取消            │
└────────────────────────┘
```

**優點**：
- 用戶有反應時間
- 可以取消

**缺點**：
- 每次都跳通知很煩
- 延遲 0.5 秒影響效率
- 搶購等場景不適用

---

### 方案 B：檢測用戶活動（智能避讓）

```python
def is_user_active():
    """檢測用戶是否正在操作"""
    # 1. 檢查滑鼠是否在移動
    pos1 = get_cursor_pos()
    time.sleep(0.05)
    pos2 = get_cursor_pos()
    if pos1 != pos2:
        return True  # 用戶正在移動滑鼠

    # 2. 檢查是否有按鍵按住
    if any_key_pressed():
        return True

    return False
```

**執行邏輯**：
```
找到目標 → 檢測用戶活動 → 活動中則等待 → 空閒後執行
```

**優點**：
- 智能判斷，不打擾用戶
- 無需額外操作

**缺點**：
- 實作複雜
- 可能誤判（用戶只是滑鼠靜止）
- 某些場景需要「強制執行」

---

### 方案 C：安全區域（Safe Zone）

```
設定「安全區域」，當游標在此區域時不執行動作：
┌─────────────────────────┐
│                         │
│    ┌─────────┐         │
│    │ 安全區  │ ← 游標在這裡時不執行
│    └─────────┘         │
│                         │
└─────────────────────────┘
```

**優點**：
- 簡單直觀
- 用戶可控

**缺點**：
- 需要額外設定
- 不夠靈活

---

### 方案 D：快捷鍵暫停（Panic Key）

```
按住 Ctrl 或 Shift 時，暫停所有自動動作
```

**優點**：
- 簡單有效
- 用戶完全可控
- 不影響正常執行效率

**缺點**：
- 需要用戶記住這個機制
- 可能與其他快捷鍵衝突

---

### 方案 E：動作佇列 + 確認（批次模式）

```
找到目標後不立即執行，而是加入佇列：
┌─────────────────────────┐
│ 待執行動作 (3)          │
│ ─────────────────────── │
│ • 點擊 確認按鈕 (2秒前) │
│ • 點擊 確認按鈕 (5秒前) │
│ • 點擊 確認按鈕 (8秒前) │
│ ─────────────────────── │
│ [全部執行] [清空]       │
└─────────────────────────┘
```

**優點**：
- 完全可控
- 可以批次處理

**缺點**：
- 失去「自動」的意義
- 不適合即時場景

---

## 推薦方案：音效提示

**核心理念**：不打斷自動流程，但讓用戶有感知。

### 執行流程
```
找到目標 → 播放提示音 → 短暫延遲(可選) → 執行動作
            ↓
         用戶聽到
            ↓
      自己暫停手上動作
```

### 音效設計
```
提示音類型：
- 短促「叮」聲（預設）
- 系統音效
- 自訂音效檔

音量：可調整 0-100%

時機：
- 執行前 0.1-0.3 秒播放
- 讓用戶有反應時間但不影響效率
```

### 設定選項
```
┌─────────────────────────────────────┐
│ 動作提示                            │
├─────────────────────────────────────┤
│ ☑ 執行前播放提示音                  │
│   音效: [系統叮聲 ▼]               │
│   音量: ────●────── 70%            │
│                                     │
│ □ 連續點擊時只響第一次              │
└─────────────────────────────────────┘
```

### 實作方式
```python
import winsound

def play_action_sound():
    """播放動作提示音"""
    # 方式1：系統音效
    winsound.MessageBeep(winsound.MB_OK)

    # 方式2：自訂頻率（更短促）
    winsound.Beep(1000, 50)  # 1000Hz, 50ms

    # 方式3：自訂檔案
    winsound.PlaySound("notify.wav", winsound.SND_ASYNC)
```

### 優點
- ✅ 不打斷自動流程
- ✅ 用戶有感知，可自行反應
- ✅ 實作簡單（Windows 內建）
- ✅ 可關閉（不想聽就關）

---

## 實作優先順序

### Phase 1（MVP）
- [ ] 執行前播放提示音（winsound.Beep）
- [ ] 設定選項：開關提示音

### Phase 2
- [ ] 音效類型選擇（系統音/自訂頻率）
- [ ] 音量調整
- [ ] 連續點擊只響一次選項

### Phase 3
- [ ] 自訂音效檔支援
- [ ] 動作日誌（事後追溯）

---

## 討論問題

1. **Panic Key 用什麼鍵？**
   - Shift（常用但可能衝突）
   - Ctrl（同上）
   - 自訂鍵
   - 滑鼠中鍵

2. **智能避讓的判斷閾值？**
   - 滑鼠靜止多久算「空閒」？
   - 要不要檢測鍵盤活動？

3. **是否需要「強制執行」模式？**
   - 搶購等場景需要忽略一切保護
   - 風險自負

4. **錯誤操作如何復原？**
   - 動作日誌
   - Undo 功能（複雜）

---

## 相關檔案

- `tray_clicker.py` - 主程式，需修改 `_execute_action_sequence()`
- `doc/exe-export-spec.md` - 導出 EXE 也需考慮此機制
